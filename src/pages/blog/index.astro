---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getPostsCollection } from '../../lib/models';

// Get page number from query params (default to 1)
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get('page') || '1'));
const postsPerPage = 10;
const skip = (currentPage - 1) * postsPerPage;

let posts: any[] = [];
let totalPosts = 0;
let totalPages = 0;

try {
  const postsCollection = await getPostsCollection();
  
  // Build query for published posts (handle both old and new schema)
  // Old schema: published field doesn't exist or is undefined -> treat as published
  // New schema: published === true
  const query = {
    $or: [
      { published: true },
      { published: { $exists: false } },
      { published: { $eq: null } }
    ]
  };
  
  // Get total count of published posts
  totalPosts = await postsCollection.countDocuments(query);
  totalPages = Math.ceil(totalPosts / postsPerPage);
  
  console.log('[Blog Index] Total published posts:', totalPosts);
  console.log('[Blog Index] Fetching page', currentPage, 'of', totalPages);
  
  // Fetch posts with pagination from MongoDB
  const fetchedPosts = await postsCollection
    .find(query)
    .sort({ createdAt: -1, date: -1 }) // Sort by date (newest first), try both fields
    .skip(skip)
    .limit(postsPerPage)
    .toArray();
  
  // Map old schema to new schema
  posts = fetchedPosts.map((post: any) => {
    return {
      ...post,
      description: post.description || post.excerpt || '',
      createdAt: post.createdAt || post.date || new Date(),
      published: typeof post.published === 'boolean' ? post.published : true,
      slug: post.slug || post._id?.toString() || '',
    };
  });
  
  console.log('[Blog Index] Fetched', posts.length, 'posts for page', currentPage);
} catch (error) {
  console.error('[Blog Index] Error fetching blog posts:', error);
  posts = [];
}

// Calculate display indices
const startIndex = skip;
const endIndex = Math.min(skip + postsPerPage, totalPosts);

// Calculate which page numbers to show in pagination
const pageNumbersToShow: number[] = [];
if (totalPages > 0) {
  for (let i = 1; i <= totalPages; i++) {
    const isFirst = i === 1;
    const isLast = i === totalPages;
    const isNearCurrent = i >= currentPage - 1 && i <= currentPage + 1;
    if (isFirst || isLast || isNearCurrent) {
      pageNumbersToShow.push(i);
    } else if (i === currentPage - 2 || i === currentPage + 2) {
      // Mark ellipsis positions
      pageNumbersToShow.push(-1); // Use -1 to represent ellipsis
    }
  }
}
---

<BaseLayout
  title="Blog - S. M. Ahad Ali Chowdhury"
  description="Read the latest blog posts about software engineering, Go, Node.js, and full-stack development."
>
  <div class="container">
    <Header />

    <!-- Blog Section -->
    <section class="blog-section">
      <h1>All Blog Posts</h1>
      {totalPosts > 0 && (
        <div>
          <p style="color: var(--text-secondary); margin-bottom: 20px;">
            Showing {startIndex + 1}-{Math.min(endIndex, totalPosts)} of {totalPosts} posts
          </p>
          <div class="blog-list">
            {posts.map((post) => {
              const viewCount = post.viewCount || 0;
              const avgReadingTime = post.readingTimes && post.readingTimes.length > 0
                ? Math.round(post.readingTimes.reduce((a: number, b: number) => a + b, 0) / post.readingTimes.length)
                : null;
              
              return (
                <a href={`/blog/${post.slug}`} class="blog-card-link">
                  <div class="blog-card">
                    <h3>{post.title}</h3>
                    <p class="blog-date">
                      {new Date(post.createdAt).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </p>
                    <p>{post.description}</p>
                    <div style="display: flex; gap: 16px; margin-top: 12px; font-size: 13px; color: var(--text-tertiary);">
                      <span>üëÅÔ∏è {viewCount} {viewCount === 1 ? 'view' : 'views'}</span>
                      {avgReadingTime !== null && (
                        <span>‚è±Ô∏è {avgReadingTime}s avg read</span>
                      )}
                    </div>
                  </div>
                </a>
              );
            })}
          </div>

          {totalPages > 1 && (
            <div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 40px; flex-wrap: wrap;">
              {currentPage > 1 ? (
                <a 
                  href={`/blog?page=${currentPage - 1}`}
                  style="
                    padding: 10px 20px;
                    background-color: var(--accent-color);
                    color: white;
                    text-decoration: none;
                    border-radius: 6px;
                    font-size: 14px;
                  "
                >
                  ‚Üê Previous
                </a>
              ) : (
                <span style="padding: 10px 20px; color: var(--text-tertiary); font-size: 14px;">‚Üê Previous</span>
              )}

              <div style="display: flex; gap: 4px; align-items: center;">
                {pageNumbersToShow.map((pageNum) => {
                  if (pageNum === -1) {
                    return <span style="padding: 0 4px; color: var(--text-tertiary);">...</span>;
                  }

                  if (pageNum === currentPage) {
                    return (
                      <span
                        style="
                          padding: 10px 16px;
                          background-color: var(--accent-color);
                          color: white;
                          border-radius: 6px;
                          font-size: 14px;
                          font-weight: 600;
                        "
                      >
                        {pageNum}
                      </span>
                    );
                  }

                  return (
                    <a
                      href={`/blog?page=${pageNum}`}
                      style="
                        padding: 10px 16px;
                        background-color: var(--bg-secondary);
                        color: var(--text-color);
                        text-decoration: none;
                        border-radius: 6px;
                        font-size: 14px;
                        border: 1px solid var(--border-color);
                      "
                    >
                      {pageNum}
                    </a>
                  );
                })}
              </div>

              {currentPage < totalPages ? (
                <a 
                  href={`/blog?page=${currentPage + 1}`}
                  style="
                    padding: 10px 20px;
                    background-color: var(--accent-color);
                    color: white;
                    text-decoration: none;
                    border-radius: 6px;
                    font-size: 14px;
                  "
                >
                  Next ‚Üí
                </a>
              ) : (
                <span style="padding: 10px 20px; color: var(--text-tertiary); font-size: 14px;">Next ‚Üí</span>
              )}
            </div>
          )}
        </div>
      )}
      {totalPosts === 0 && (
        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
          No blog posts found.
        </p>
      )}
    </section>

    <Footer />
  </div>
</BaseLayout>

