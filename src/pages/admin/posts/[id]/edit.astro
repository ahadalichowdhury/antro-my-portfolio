---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import RichTextEditor from '../../../../components/RichTextEditor';
import { requireAuth } from '../../../../lib/session';
import { getPostsCollection } from '../../../../lib/models';
import { ObjectId } from 'mongodb';

const session = await requireAuth(Astro.cookies);
if (!session) {
  return Astro.redirect('/admin/login');
}

const { id } = Astro.params;
if (!id) {
  return Astro.redirect('/admin');
}

const postsCollection = await getPostsCollection();
const post = await postsCollection.findOne({ _id: new ObjectId(id) });

if (!post) {
  return Astro.redirect('/admin');
}
---

<BaseLayout title="Edit Post - Admin">
  <div class="container">
    <h1>Edit Post</h1>
    <form method="POST" action={`/admin/posts/${id}/edit-api`} id="post-form" style="margin-top: 30px;">
      <div style="margin-bottom: 20px;">
        <label for="title" style="display: block; margin-bottom: 8px; font-weight: 500;">Title</label>
        <input
          type="text"
          id="title"
          name="title"
          value={post.title}
          required
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
          "
        />
      </div>

      <div style="margin-bottom: 20px;">
        <label for="slug" style="display: block; margin-bottom: 8px; font-weight: 500;">Slug</label>
        <input
          type="text"
          id="slug"
          name="slug"
          value={post.slug}
          required
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
          "
        />
      </div>

      <div style="margin-bottom: 20px;">
        <label for="description" style="display: block; margin-bottom: 8px; font-weight: 500;">Description</label>
        <textarea
          id="description"
          name="description"
          required
          rows="3"
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
          "
        >{post.description}</textarea>
      </div>

      <div style="margin-bottom: 20px;">
        <label for="coverImage" style="display: block; margin-bottom: 8px; font-weight: 500;">Cover Image URL</label>
        <input
          type="url"
          id="coverImage"
          name="coverImage"
          value={post.coverImage || ''}
          placeholder="https://example.com/image.jpg"
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
          "
        />
        <small style="color: var(--text-tertiary); font-size: 13px;">Optional: URL to the cover image for this post</small>
        <div id="image-preview" style="margin-top: 12px; display: none;">
          <img id="preview-img" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 6px; border: 1px solid var(--border-color);" />
        </div>
        {post.coverImage && (
          <div style="margin-top: 12px;">
            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 8px;">Current image:</p>
            <img src={post.coverImage} alt="Current cover" style="max-width: 100%; max-height: 300px; border-radius: 6px; border: 1px solid var(--border-color);" />
          </div>
        )}
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Content Format</label>
        <div style="display: flex; gap: 20px; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="contentFormat" value="html" id="format-html" checked={post.contentFormat !== 'markdown'} />
            <span>Rich Text (HTML)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="contentFormat" value="markdown" id="format-markdown" checked={post.contentFormat === 'markdown'} />
            <span>Markdown</span>
          </label>
        </div>
        <input type="hidden" name="contentFormat" id="contentFormat" value={post.contentFormat || 'html'} />
        
        <label for="content" style="display: block; margin-bottom: 8px; font-weight: 500;">Content</label>
        {post.contentFormat === 'markdown' ? (
          <>
            <div id="rich-text-editor-container" style="display: none;">
              <RichTextEditor client:load initialValue="" />
            </div>
            <textarea
              id="markdown-editor"
              name="markdownContent"
              style="width: 100%; min-height: 400px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); resize: vertical;"
              placeholder="Write your blog post in Markdown format..."
            >{post.content}</textarea>
          </>
        ) : (
          <>
            <div id="rich-text-editor-container">
              <RichTextEditor client:load initialValue={post.content} />
            </div>
            <textarea
              id="markdown-editor"
              name="markdownContent"
              style="display: none; width: 100%; min-height: 400px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); resize: vertical;"
              placeholder="Write your blog post in Markdown format..."
            ></textarea>
          </>
        )}
        <textarea
          id="content"
          name="content"
          style="display: none;"
        >{post.content}</textarea>
      </div>

      <div style="margin-bottom: 20px;">
        <label for="tags" style="display: block; margin-bottom: 8px; font-weight: 500;">Tags (comma-separated)</label>
        <input
          type="text"
          id="tags"
          name="tags"
          value={post.tags.join(', ')}
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
          "
        />
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" name="published" id="published" value="true" checked={post.published} />
          <span>Published</span>
        </label>
      </div>

      <div style="display: flex; gap: 12px;">
        <button
          type="submit"
          style="
            padding: 12px 24px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
          "
        >
          Update Post
        </button>
        <a
          href="/admin"
          style="
            padding: 12px 24px;
            background-color: var(--border-color);
            color: var(--text-color);
            text-decoration: none;
            border-radius: 6px;
            font-size: 16px;
            display: inline-block;
          "
        >
          Cancel
        </a>
      </div>
    </form>
  </div>

  <script>
    // Wait for React component to mount, then sync on form submit
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('post-form');
      const formatHtml = document.getElementById('format-html');
      const formatMarkdown = document.getElementById('format-markdown');
      const contentFormatHidden = document.getElementById('contentFormat');
      const richTextContainer = document.getElementById('rich-text-editor-container');
      const markdownEditor = document.getElementById('markdown-editor');
      
      // Handle format switching
      function switchFormat(format: string) {
        if (format === 'html') {
          if (richTextContainer) richTextContainer.style.display = 'block';
          if (markdownEditor) markdownEditor.style.display = 'none';
          if (contentFormatHidden) contentFormatHidden.value = 'html';
        } else {
          if (richTextContainer) richTextContainer.style.display = 'none';
          if (markdownEditor) markdownEditor.style.display = 'block';
          if (contentFormatHidden) contentFormatHidden.value = 'markdown';
        }
      }
      
      if (formatHtml) {
        formatHtml.addEventListener('change', () => {
          if (formatHtml.checked) switchFormat('html');
        });
      }
      
      if (formatMarkdown) {
        formatMarkdown.addEventListener('change', () => {
          if (formatMarkdown.checked) switchFormat('markdown');
        });
      }
      
      if (form) {
        form.addEventListener('submit', (e) => {
          console.log('[Frontend] Form submit intercepted');
          
          const currentFormat = contentFormatHidden?.value || 'html';
          const contentField = document.getElementById('content') as HTMLTextAreaElement;
          
          if (currentFormat === 'html') {
            // Sync content from rich text editor
            const editor = document.querySelector('.ql-editor');
            
            if (editor && contentField) {
              const content = editor.innerHTML.trim();
              contentField.value = content;
              console.log('[Frontend] Content synced from editor:', content.substring(0, 50) + '...');
              
              // Validate content is not empty
              if (!content || content === '<p><br></p>' || content === '<p></p>') {
                e.preventDefault();
                alert('Please enter some content for your blog post.');
                console.error('[Frontend] Content is empty, preventing submission');
                return false;
              }
            } else {
              console.warn('[Frontend] Editor or content field not found');
              if (!editor) {
                e.preventDefault();
                alert('Editor not loaded. Please wait a moment and try again.');
                console.error('[Frontend] Editor not found, preventing submission');
                return false;
              }
            }
          } else {
            // Sync content from markdown editor
            const markdownContent = markdownEditor?.value.trim() || '';
            if (contentField) {
              contentField.value = markdownContent;
              console.log('[Frontend] Markdown content synced:', markdownContent.substring(0, 50) + '...');
              
              // Validate markdown content is not empty
              if (!markdownContent) {
                e.preventDefault();
                alert('Please enter some content for your blog post.');
                console.error('[Frontend] Markdown content is empty, preventing submission');
                return false;
              }
            }
          }
          
          // Handle published checkbox - if unchecked, add hidden field
          const publishedCheckbox = document.getElementById('published');
          // Remove any existing hidden published field first
          const existingHidden = form.querySelector('input[name="published"][type="hidden"]');
          if (existingHidden) {
            existingHidden.remove();
          }
          
          if (!publishedCheckbox || !(publishedCheckbox as HTMLInputElement).checked) {
            // Add a hidden field to explicitly set published to false
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'published';
            hiddenField.value = 'false';
            form.appendChild(hiddenField);
            console.log('[Frontend] Published checkbox unchecked, adding hidden field');
          } else {
            console.log('[Frontend] Published checkbox checked');
          }
          
          // Let the form submit naturally - don't prevent default
          console.log('[Frontend] Allowing form to submit');
        });
      } else {
        console.error('[Frontend] Form not found!');
      }

      // Image preview functionality
      const coverImageInput = document.getElementById('coverImage');
      const imagePreview = document.getElementById('image-preview');
      const previewImg = document.getElementById('preview-img');
      
      if (coverImageInput && imagePreview && previewImg) {
        // Show preview if there's an initial value
        if (coverImageInput.value) {
          previewImg.src = coverImageInput.value;
          imagePreview.style.display = 'block';
        }
        
        coverImageInput.addEventListener('input', (e) => {
          const url = e.target.value.trim();
          if (url) {
            previewImg.src = url;
            imagePreview.style.display = 'block';
            previewImg.onerror = () => {
              imagePreview.style.display = 'none';
            };
          } else {
            imagePreview.style.display = 'none';
          }
        });
      }
    });
  </script>
</BaseLayout>

